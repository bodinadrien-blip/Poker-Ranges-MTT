<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Poker Ranges MTT Pro</title>

<!-- iOS PWA -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Poker Ranges">
<link rel="apple-touch-icon" href="icon-192.png">
<link rel="manifest" href="manifest.json">

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
:root{
  --bg:#0b0d10;
  --panel:#141820;
  --border:#1f2633;
  --open:#2ecc71;
  --call:#1e88e5;
  --bet3:#ff9800;
  --allin:#e53935;
  --fold:#2a2f3a;
  --text:#fff;
  --muted:#8a93a3;
}

body{
  margin:0;
  background:radial-gradient(circle at top,#121621,#07090c);
  color:var(--text);
  font-family:-apple-system,BlinkMacSystemFont,Arial;
}

header{
  padding:14px;
  text-align:center;
  font-weight:800;
  letter-spacing:1px;
  background:linear-gradient(180deg,#111520,#0a0c11);
  border-bottom:1px solid var(--border);
}

.container{padding:12px}

select,button{
  width:100%;
  padding:12px;
  margin-bottom:10px;
  border-radius:10px;
  border:1px solid var(--border);
  background:var(--panel);
  color:var(--text);
  font-size:15px;
  font-weight:600;
  letter-spacing:.4px;
}

select option{font-weight:600}

button{
  background:linear-gradient(135deg,#1f2937,#111827);
}
button:active{transform:scale(.98)}

.grid{
  display:grid;
  grid-template-columns:repeat(13,1fr);
  gap:2px;
  width:100%;
}

.cell{
  aspect-ratio:1/1;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:clamp(13px,3.4vw,24px);
  border-radius:8px;
  font-weight:700;
  letter-spacing:.4px;
  box-shadow:inset 0 0 0 1px rgba(255,255,255,.06);
}

.open{background:linear-gradient(135deg,#1e824c,var(--open))}
.call{background:linear-gradient(135deg,#1565c0,var(--call))}
.bet3{background:linear-gradient(135deg,#ff6f00,var(--bet3));color:#000}
.allin{background:linear-gradient(135deg,#b71c1c,var(--allin))}
.fold{background:var(--fold);color:var(--muted)}

.legend{
  display:flex;
  justify-content:space-between;
  font-size:12px;
  margin:8px 0;
  color:var(--muted);
}
.legend div{display:flex;align-items:center;gap:4px}
.box{width:12px;height:12px;border-radius:3px}

#percent{
  text-align:center;
  font-weight:800;
  margin:8px 0;
}

/* Tooltip */
.info{
  font-size:13px;
  color:var(--muted);
  margin:-4px 0 10px;
  position:relative;
}
.tooltip{
  display:none;
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:8px;
  padding:10px;
  margin-top:6px;
  font-size:12px;
}
.info-row{
  display:flex;
  gap:14px;
  align-items:center;
  margin:-4px 0 10px;
  flex-wrap:wrap; /* safe iPhone */
}

.info{
  font-size:13px;
  color:var(--muted);
  position:relative;
  user-select:none;
}

.info .tooltip{
  display:none;
  position:absolute;
  top:26px;
  left:0;
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:8px;
  padding:10px;
  font-size:12px;
  line-height:1.4;
  box-shadow:0 8px 30px rgba(0,0,0,.8);
  z-index:9999;          /* üî• CRITIQUE */
  min-width:180px;
}

.info{
  position:relative;
  pointer-events:auto;
  z-index:10;
}

.coach-on .cell{
  pointer-events:none;
  filter:brightness(.9);
}

.coach-banner{
  text-align:center;
  font-size:12px;
  color:#ff9800;
  margin-bottom:6px;
  font-weight:700;
}

.actions{
  display:flex;
  gap:8px;
}

.actions button{
  background:linear-gradient(135deg,#1f2937,#0f172a);
  border:1px solid #1f2937;
}
</style>
</head>

<body>
<header>‚ô†Ô∏è POKER RANGES ‚Äî MTT PRO</header>

<div class="container">

<select id="spot">
  <option>UTG</option><option>HJ</option><option>CO</option>
  <option>BTN</option><option>SB</option><option>BB</option>
</select>

<select id="action">
  <option value="open">Open</option>
  <option value="call">Call</option>
  <option value="bet3">3bet</option>
  <option value="allin">All-in</option>
  <option value="fold">Fold</option>
</select>

<div class="info-row">

  <div id="openInfo" class="info">
    ‚ÑπÔ∏è Open size
    <div class="tooltip">
      <strong>Open size</strong><br>
      x2 = standard<br>
      x2.5 = pression<br>
      x3 = iso / punition
    </div>
  </div>

  <div id="sbInfo" class="info">
    ‚ÑπÔ∏è SB vs BB
    <div class="tooltip">
      <strong>SB vs BB</strong><br>
      x3.5 = D√©but tournoi<br>
      x2.5 = Milieu tournoi<br>
      x2.1 = Fin tournoi
    </div>
  </div>

</div>
</div>

<select id="stack">
  o.value = `${opt.label}_${opt.mult || ""}`;
o.textContent = opt.mult
  ? `${opt.label} (${opt.mult})`
  : opt.label;
</select>

<div class="actions">
  <button id="coachToggle">üß† Mode coach : OFF</button>
<button onclick="resetRange()">üîÑ RESET RANGE</button>
</div>
<div class="actions">
  <button onclick="exportImage()">üì§ Image</button>
  <button onclick="exportJSON()">üíæ JSON</button>
  <button onclick="importJSON()">üìÇ Import</button>
</div>

<div id="percent">Range : 0%</div>

<div class="legend">
  <div><div class="box open"></div>Open</div>
  <div><div class="box call"></div>Call</div>
  <div><div class="box bet3"></div>3bet</div>
  <div><div class="box allin"></div>All-in</div>
  <div><div class="box fold"></div>Fold</div>
</div>

<div id="grid" class="grid"></div>
</div>

<script>
const ranks=["A","K","Q","J","T","9","8","7","6","5","4","3","2"];
const grid=document.getElementById("grid");
const percent=document.getElementById("percent");
const openInfo=document.getElementById("openInfo");

const stackOptionsByPosition = {
  UTG:{
    open:[
      {label:"20bb",mult:"x2"},
      {label:"30bb",mult:"x2.5"},
      {label:"45bb",mult:"x3"}
    ],
    call:[
      {label:"Standard",mult:"2bb x3 possible cher"}
    ],
    bet3:[
      {label:"12‚Äì30bb",mult:"Deep stack"},
      {label:"30‚Äì50bb",mult:"3bet short"},
      {label:"12‚Äì30bb",mult:"3bet light"}
    ],
    allin:[
      {label:"si relance ac +25bb",mult:"call ou rase"}
    ],
    fold:[{label:"‚Äî"}]
  },

  HJ:{
    open:[
      {label:"20bb",mult:"x2"},
      {label:"30bb",mult:"x2.5"},
      {label:"45bb",mult:"x3"}
    ],
    call:[
      {label:"Standard",mult:"2bb x3 possible cher"}
    ],
    bet3:[
      {label:"12‚Äì30bb",mult:"Deep stack"},
      {label:"30‚Äì50bb",mult:"3bet short"},
      {label:"12‚Äì30bb",mult:"3bet light"}
    ],
    allin:[
      {label:"si relance ac +25bb",mult:"call ou rase"}
    ],
    fold:[{label:"‚Äî"}]
  },

  CO:{
    open:[
      {label:"20bb",mult:"x2"},
      {label:"30bb",mult:"x2.5"},
      {label:"45bb",mult:"x3"}
    ],
    call:[
      {label:"Standard",mult:"2bb"}
    ],
    bet3:[
      {label:"12‚Äì30bb",mult:"Deep stack"},
      {label:"30‚Äì50bb",mult:"3bet short"},
      {label:"12‚Äì30bb",mult:"3bet light"}
    ],
    allin:[
      {label:"si relance ac +25bb",mult:"call ou rase"}
    ],
    fold:[{label:"‚Äî"}]
  },

  BTN:{
    open:[
      {label:"20bb",mult:"x2"},
      {label:"30bb",mult:"x2.5"},
      {label:"45bb",mult:"x3"}
    ],
    call:[
      {label:"Standard",mult:"2bb"}
    ],
    bet3:[
      {label:"12‚Äì30bb",mult:"Deep stack"},
      {label:"30‚Äì50bb",mult:"3bet short"},
      {label:"12‚Äì30bb",mult:"3bet light"}
    ],
    allin:[
      {label:"+25bb"}
    ],
    fold:[{label:"‚Äî"}]
  },

  SB:{
    open:[
      {label:"D mtt",mult:"x3.5"},
      {label:"M mtt",mult:"x2.5"},
      {label:"F mtt",mult:"x2.1"}
    ],
    call:[
      {label:"Si pas relance",mult:"2bb"},
      {label:"Si pas relance",mult:"relance +2bb"},
      {label:"Limp / relance",mult:"1bb"},
      {label:"+30bb Limp / relance",mult:"1bb"}
    ],
    bet3:[
      {label:"12‚Äì30bb",mult:"Deep stack"},
      {label:"30‚Äì50bb",mult:"3bet short"},
      {label:"12‚Äì30bb",mult:"3bet light"}
    ],
    allin:[
      {label:"si relance ac +25bb",mult:"call ou rase"}
    ],
    fold:[{label:"‚Äî"}]
  },

  BB:{
    open:[
      {label:"D mtt",mult:"x3.5"},
      {label:"M mtt",mult:"x2.5"},
      {label:"F mtt",mult:"x2.1"}
    ],
    call:[
      {label:"Call",mult:"2bb"},
      {label:"Rase",mult:"min 2bb ‚Üí x3 / tapis si multiway"}
    ],
    bet3:[
      {label:"12‚Äì30bb",mult:"Deep stack"},
      {label:"30‚Äì50bb",mult:"3bet short"},
      {label:"12‚Äì30bb",mult:"3bet light"}
    ],
    allin:[
      {label:"si relance ac +25bb",mult:"call ou rase"},
      {label:"‚â§12bb"},
      {label:"‚â§8bb"}
    ],
    fold:[{label:"‚Äî"}]
  }
};

/* ---------- IndexedDB ---------- */
let db;
const DB_NAME="PokerRangesDB";
const STORE="ranges";

const req=indexedDB.open(DB_NAME,1);
req.onupgradeneeded=e=>{
  db=e.target.result;
  db.createObjectStore(STORE);
};
req.onsuccess=e=>{
  db=e.target.result;
  updateStackOptions();
  build();
};

function key(){
  return `range_${spot.value}_${action.value}_${stack.value}`;
}

function save(data){
  const tx=db.transaction(STORE,"readwrite");
  tx.objectStore(STORE).put(data,key());
}

function load(cb){
  const tx=db.transaction(STORE,"readonly");
  const r=tx.objectStore(STORE).get(key());
  r.onsuccess=()=>cb(r.result||{});
}

function updateStackOptions(){
  stack.innerHTML="";

  const pos = spot.value;
  const act = action.value;

  const options = stackOptionsByPosition[pos][act] || [];

  options.forEach(o=>{
    const opt=document.createElement("option");
    opt.value=o.label;
    opt.innerHTML=o.mult
      ? `${o.label} <span style="opacity:.6">(${o.mult})</span>`
      : o.label;
    stack.appendChild(opt);
  });
}

function key(){
  return `range_${spot.value}_${stack.value}`;
}

function build(){
  if(!db) return;
  grid.innerHTML="";
  load(saved=>{
    ranks.forEach((r,i)=>{
      ranks.forEach((c,j)=>{
        const h=i==j?r+r:i<j?r+c+"s":c+r+"o";
        const d=document.createElement("div");
        d.className="cell "+(saved[h]||"fold");
        d.textContent=h;
        d.onclick=()=>{
  if(coachMode) return;

  const current = saved[h] || "fold";

  if(current === action.value){
    // üîÅ second clic = retirer la main
    d.className = "cell fold";
    delete saved[h];
  }else{
    // üé® appliquer l‚Äôaction
    d.className = "cell " + action.value;
    saved[h] = action.value;
  }

  save(saved);
  updatePercent();
};
        grid.appendChild(d);
      });
    });
    updatePercent();
  });
}

function updatePercent(){
  const a=[...document.querySelectorAll(".cell")].filter(c=>!c.classList.contains("fold")).length;
  percent.textContent=`${spot.value} ¬∑ ${action.value} ¬∑ ${stack.value} : ${(a/169*100).toFixed(1)}%`;
}

function resetRange(){
  if(confirm("Effacer cette range ?")){
    const tx=db.transaction(STORE,"readwrite");
    tx.objectStore(STORE).delete(key());
    build();
  }
}

function exportImage(){
  html2canvas(grid).then(c=>{
    const a=document.createElement("a");
    a.download=`${spot.value}_${action.value}_${stack.value}.png`;
    a.href=c.toDataURL();
    a.click();
  });
}

/* UI */
openInfo.onclick=()=>{
  const t=openInfo.querySelector(".tooltip");
  t.style.display=t.style.display==="block"?"none":"block";
};

action.onchange=()=>{
  updateStackOptions();
  openInfo.style.display=action.value==="open"?"block":"none";
  build();
};

spot.onchange = ()=>{
  updateStackOptions();
  build();
};

action.onchange = ()=>{
  updateStackOptions();
  openInfo.style.display = action.value==="open" ? "block" : "none";
  build();
};

document.querySelectorAll(".info").forEach(el=>{
  el.onclick = e=>{
    e.stopPropagation();

    document.querySelectorAll(".tooltip").forEach(t=>{
      if(t !== el.querySelector(".tooltip")) t.style.display="none";
    });

    const t = el.querySelector(".tooltip");
    t.style.display = t.style.display==="block" ? "none" : "block";
  };
});

document.body.onclick = ()=>{
  document.querySelectorAll(".tooltip").forEach(t=>t.style.display="none");
};

let coachMode = false;
const coachBtn = document.getElementById("coachToggle");

coachBtn.onclick = ()=>{
  coachMode = !coachMode;

  document.body.classList.toggle("coach-on", coachMode);

  coachBtn.textContent = coachMode
    ? "üß† Mode coach : ON"
    : "üß† Mode coach : OFF";
};

function exportJSON(){
  const tx = db.transaction("ranges","readonly");
  const store = tx.objectStore("ranges");
  const req = store.getAll();
  const keysReq = store.getAllKeys();

  Promise.all([
    new Promise(res=>req.onsuccess=()=>res(req.result)),
    new Promise(res=>keysReq.onsuccess=()=>res(keysReq.result))
  ]).then(([values,keys])=>{
    const data = {};
    keys.forEach((k,i)=>data[k]=values[i]);

    const blob = new Blob(
      [JSON.stringify(data,null,2)],
      {type:"application/json"}
    );

    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "poker_ranges_backup.json";
    a.click();
  });
}

function importJSON(){
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "application/json";

  input.onchange = e=>{
    const file = e.target.files[0];
    if(!file) return;

    const reader = new FileReader();
    reader.onload = ()=>{
      try{
        const data = JSON.parse(reader.result);
        const tx = db.transaction("ranges","readwrite");
        const store = tx.objectStore("ranges");

        Object.keys(data).forEach(k=>{
          store.put(data[k],k);
        });

        alert("‚úÖ Ranges import√©es avec succ√®s");
        build();
      }catch(err){
        alert("‚ùå Fichier invalide");
      }
    };
    reader.readAsText(file);
  };

  input.click();
}
</script>
</body>
</html>